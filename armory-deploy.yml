version: v1
kind: kubernetes
application: Anythink
targets: 
  staging:
    account: prod
    namespace: anythink-market-yxfrdwlx
    strategy: blue-green-deploy-strat
    constraints:
      afterDeployment:
      - runWebhook:
          name: Notify_Wilco_Completion
          context:
            environment: staging
            
manifests:  
  - path: manifests/anythink.yml
  
trafficManagement:
  - targets: [staging]
    kubernetes:
      - activeService: anythink-frontend
      - previewService: anythink-frontend
      - activeService: anythink-backend
      - previewService: anythink-backend
      
strategies: 
  blue-green-deploy-strat:
    bluegreen:
      redirectTrafficAfter:
        - pause:
            untilApproved: true
      shutDownOldVersionAfter:
        - pause:
            untilApproved: true
  rolling:
    canary:
      steps: 
      - setWeight:
          weight: 100
webhooks: 
  - name: Notify_Wilco_Completion
    method: POST
    uriTemplate: https://engine.wilco.gg/users/{{secrets.WILCO_ID}}/event
    headers:
    -  Key: Content-Type
       value: application/json
    bodyTemplate:
      inline:  >-
        {
        "event": "armory_webhook",
        "payload": {
            "environment": "{{context.environment}}"
            }
        }
    retryCount: 3
    disableCallback: true

  - name: Armory CD-as-a-Service Deployment
    id: deploy
    uses: armory/cli-deploy-action@main
    with:
      clientId: "${{ secrets.ARMORY_CLIENT_ID }}" 
      clientSecret:  "${{ secrets.ARMORY_CLIENT_SECRET }}" 
      path-to-file: ".github/workflows/wilco-actions.yml" 
      waitForDeployment: <true-or-false>